<!-- HTML header for doxygen 1.8.15-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>51Degrees Device Detection C/C++: Hash/Performance.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="examplegrabber.js"></script>
<script type="text/javascript" src="testedversionsgrabber.js"></script>
<script type="text/javascript" src="search51.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="docs-main.min.css" rel="stylesheet" type="text/css" />
</head>
<body class="l-docs-index p-doxygen">
<div class="l-index__content">
<!--div id="top"--><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea" class="g-header g-header--docs">
  <h1 class="c-brand">
  <a id="projectlogo" href="../../documentation/4.4/index.html" class="c-brand__link"><img class="c-brand__image" alt="Logo" src="logo-51Degrees-Docs.png" style="width:172px;"/></a>
  <span class="c-tagline">51Degrees Device Detection C/C++
   &#160;<span id="projectnumber">4.4</span>
  </span>
  </h1>
  <div id="projectalign" style="padding-left: 0.5em;">
   <div id="projectbrief">A device detection library that is used natively or by 51Degrees products</div>
  </div>
  <div id="main-nav"></div>
  <section class="g-search">
    <div class="c-search is-openable" id="searchOpenable">
    <form class="c-search__form">
      <div class="b-form-group b-form-group--with-icon">
        <label for="inputSearch" class="b-text--hidden">Search</label>
        <img src="icon-search.svg" class="b-icon" alt="Search" />
        <input type="text" class="c-search__input" id="inputSearch" onkeyup="javascript:onSearch(this,event.keyCode)" placeholder="Search" aria-label="Search">
      </div>
    </form>
    <div class="c-search__content" id="searchContent">
    </div>
  </div> 
  </section>
</div>
<!-- end header part -->
<main class="g-main">
<!-- Generated by Doxygen 1.8.15 -->
<!-- top -->
	<div class="g-docs__sidenav">																														         <nav id="nav-tree-contents" class="c-sidenav">																														     <h4 class="c-sidenav__heading">Documentation</h4>																									         <div id="nav-sync" class="sync"></div>
  <ul class="c-sidenav__list">																														     </ul>																																				   </nav>    </div><script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('_hash_2_performance_8c-example.html','');});
/* @license-end */
</script>
<div id="doc-content" class="g-docs__content">
<div class="g-docs__header">
<h2 class="g-docs__page-title">Hash/Performance.c</h2></div><!--header-->
<div class="g-docs__inner">
<div class="g-docs__primary" id="primary">
<p>The example illustrates a "clock-time" benchmark for assessing detection speed.Using a YAML formatted evidence file - "20000 Evidence Records.yml" - supplied with the distribution or can be obtained from the <a href="https://github.com/51Degrees/device-detection-data/blob/main/20000%20Evidence%20Records.yml">data repository on Github</a>.</p>
<p>It's important to understand the trade-offs between performance, memory usage and accuracy, that the 51Degrees pipeline configuration makes available, and this example shows a range of different configurations to illustrate the difference in performance.</p>
<p>Requesting properties from a single component reduces detection time compared with requesting properties from multiple components. If you don't specify any properties to detect, then all properties are detected.</p>
<p>Please review <a href="https://51degrees.com/documentation/_device_detection__features__performance_options.html">performance options</a> and <a href="https://51degrees.com/documentation/_device_detection__hash.html#DeviceDetection_Hash_DataSetProduction_Performance">hash dataset options</a> for more information about adjusting performance.</p>
<p>This example is available in full on <a href="https://github.com/51Degrees/device-detection-cxx/blob/master/examples/C/Hash/Performance.c">GitHub</a>.</p>
<div class="c-code__block c-code__block--outline"><div class="c-code__line"><span class="c-code__comment">/* *********************************************************************</span></div><div class="c-code__line"><span class="c-code__comment"> * This Original Work is copyright of 51 Degrees Mobile Experts Limited.</span></div><div class="c-code__line"><span class="c-code__comment"> * Copyright 2023 51 Degrees Mobile Experts Limited, Davidson House,</span></div><div class="c-code__line"><span class="c-code__comment"> * Forbury Square, Reading, Berkshire, United Kingdom RG1 3EU.</span></div><div class="c-code__line"><span class="c-code__comment"> *</span></div><div class="c-code__line"><span class="c-code__comment"> * This Original Work is licensed under the European Union Public Licence</span></div><div class="c-code__line"><span class="c-code__comment"> * (EUPL) v.1.2 and is subject to its terms as set out below.</span></div><div class="c-code__line"><span class="c-code__comment"> *</span></div><div class="c-code__line"><span class="c-code__comment"> * If a copy of the EUPL was not distributed with this file, You can obtain</span></div><div class="c-code__line"><span class="c-code__comment"> * one at https://opensource.org/licenses/EUPL-1.2.</span></div><div class="c-code__line"><span class="c-code__comment"> *</span></div><div class="c-code__line"><span class="c-code__comment"> * The &#39;Compatible Licences&#39; set out in the Appendix to the EUPL (as may be</span></div><div class="c-code__line"><span class="c-code__comment"> * amended by the European Commission) shall be deemed incompatible for</span></div><div class="c-code__line"><span class="c-code__comment"> * the purposes of the Work and the provisions of the compatibility</span></div><div class="c-code__line"><span class="c-code__comment"> * clause in Article 5 of the EUPL shall not apply.</span></div><div class="c-code__line"><span class="c-code__comment"> *</span></div><div class="c-code__line"><span class="c-code__comment"> * If using the Work as, or as part of, a network application, by</span></div><div class="c-code__line"><span class="c-code__comment"> * including the attribution notice(s) required under Article 5 of the EUPL</span></div><div class="c-code__line"><span class="c-code__comment"> * in the end user terms of the application under an appropriate heading,</span></div><div class="c-code__line"><span class="c-code__comment"> * such notice(s) shall fulfill the requirements of that article.</span></div><div class="c-code__line"><span class="c-code__comment"> * ********************************************************************* */</span></div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__preprocessor">#include &lt;stdio.h&gt;</span></div><div class="c-code__line"><span class="c-code__preprocessor">#include &lt;time.h&gt;</span></div><div class="c-code__line"></div><div class="c-code__line"> <span class="c-code__comment">// Include ExmapleBase.h before others as it includes Windows &#39;crtdbg.h&#39;</span></div><div class="c-code__line"> <span class="c-code__comment">// which requires to be included before &#39;malloc.h&#39;.</span></div><div class="c-code__line"><span class="c-code__preprocessor">#include &quot;ExampleBase.h&quot;</span></div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__comment">// the default number of threads if one is not provided.</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define DEFAULT_NUMBER_OF_THREADS 2</span></div><div class="c-code__line"><span class="c-code__comment">// the default number of tests to execute.</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define DEFAULT_ITERATIONS_PER_THREAD 10000</span></div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__comment">// Parameters used for allocating memory when reading evidence. </span></div><div class="c-code__line"><span class="c-code__preprocessor">#define SIZE_OF_KEY 500</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define SIZE_OF_VALUE 1000</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define MAX_EVIDENCE 20</span></div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__comment">// The device detection data folder from the sub module with lite device data.</span></div><div class="c-code__line"><span class="c-code__keyword">static</span> <span class="c-code__keyword">const</span> <span class="c-code__keywordtype">char</span>* dataDir = <span class="c-code__stringliteral">&quot;device-detection-data&quot;</span>;</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__comment">// In this example, by default, the 51degrees &quot;Lite&quot; file needs to be in the</span></div><div class="c-code__line"><span class="c-code__comment">// device-detection-data,</span></div><div class="c-code__line"><span class="c-code__comment">// or you may specify another file as a command line parameter.</span></div><div class="c-code__line"><span class="c-code__comment">//</span></div><div class="c-code__line"><span class="c-code__comment">// Note that the Lite data file is only used for illustration, and has</span></div><div class="c-code__line"><span class="c-code__comment">// limited accuracy and capabilities.</span></div><div class="c-code__line"><span class="c-code__comment">// Find out about the Enterprise data file on our pricing page:</span></div><div class="c-code__line"><span class="c-code__comment">// https://51degrees.com/pricing</span></div><div class="c-code__line"><span class="c-code__keyword">static</span> <span class="c-code__keyword">const</span> <span class="c-code__keywordtype">char</span>* dataFileName = <span class="c-code__stringliteral">&quot;51Degrees-LiteV4.1.hash&quot;</span>;</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__comment">// This file contains the 20,000 most commonly seen combinations of header </span></div><div class="c-code__line"><span class="c-code__comment">// values that are relevant to device detection. For example, User-Agent and </span></div><div class="c-code__line"><span class="c-code__comment">// UA-CH headers.</span></div><div class="c-code__line"><span class="c-code__keyword">static</span> <span class="c-code__keyword">const</span> <span class="c-code__keywordtype">char</span>* evidenceFileName = <span class="c-code__stringliteral">&quot;20000 Evidence Records.yml&quot;</span>;</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__comment">// The value of the evidence for User-Agent is not stored in the shared string</span></div><div class="c-code__line"><span class="c-code__comment">// structure as these are almost always unique.</span></div><div class="c-code__line"><span class="c-code__keyword">static</span> <span class="c-code__keyword">const</span> <span class="c-code__keywordtype">char</span>* userAgent = <span class="c-code__stringliteral">&quot;user-agent&quot;</span>;</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">typedef</span> <span class="c-code__keyword">struct </span>performanceConfig_t {</div><div class="c-code__line">    <span class="c-code__comment">// Base configuration</span></div><div class="c-code__line">    <a name="_a0"></a><a class="code" href="structfiftyone_degrees_config_hash.html">ConfigHash</a> *config;</div><div class="c-code__line">    <span class="c-code__comment">// True if all properties should be initialized and fetched</span></div><div class="c-code__line">    <span class="c-code__keywordtype">bool</span> allProperties;</div><div class="c-code__line">} <a name="_a1"></a><a class="code" href="structperformance_config.html">performanceConfig</a>;</div><div class="c-code__line"></div><div class="c-code__line"><a class="code" href="structperformance_config.html">performanceConfig</a> performanceConfigs[] = {</div><div class="c-code__line">    { &amp;<a name="a2"></a><a class="code" href="group___fifty_one_degrees_hash_synonyms.html#ga90e4ca7b9a7843dcfd2ab2a2340ca694">HashInMemoryConfig</a>, <span class="c-code__keyword">false</span> },</div><div class="c-code__line">    { &amp;<a class="code" href="group___fifty_one_degrees_hash_synonyms.html#ga90e4ca7b9a7843dcfd2ab2a2340ca694">HashInMemoryConfig</a>, <span class="c-code__keyword">true</span> } };</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">typedef</span> <span class="c-code__keyword">struct </span>benchmarkResult_t {</div><div class="c-code__line">    <span class="c-code__comment">// Number of device evidence processed to determine the result.</span></div><div class="c-code__line">    <span class="c-code__keywordtype">long</span> count;</div><div class="c-code__line">    <span class="c-code__comment">// Processing time in millis this thread</span></div><div class="c-code__line">    <span class="c-code__keywordtype">double</span> elapsedMillis;</div><div class="c-code__line">    <span class="c-code__comment">// Used to ensure compiler optimiser doesn&#39;t optimise out the very</span></div><div class="c-code__line">    <span class="c-code__comment">// method that the benchmark is testing.</span></div><div class="c-code__line">    <span class="c-code__keywordtype">unsigned</span> <span class="c-code__keywordtype">long</span> checkSum;</div><div class="c-code__line">} <a name="_a3"></a><a class="code" href="structbenchmark_result.html">benchmarkResult</a>;</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">typedef</span> <span class="c-code__keyword">struct </span>evidence_node_t <a name="_a4"></a><a class="code" href="structevidence_node.html">evidenceNode</a>;</div><div class="c-code__line"><span class="c-code__keyword">typedef</span> <span class="c-code__keyword">struct </span>evidence_node_t {</div><div class="c-code__line">    <a name="_a5"></a><a class="code" href="structfiftyone_degrees_evidence_key_value_pair_array.html">EvidenceKeyValuePairArray</a>* array; <span class="c-code__comment">// evidence </span></div><div class="c-code__line">    <a class="code" href="structevidence_node.html">evidenceNode</a>* next; <span class="c-code__comment">// null if the end of the list</span></div><div class="c-code__line">} <a class="code" href="structevidence_node.html">evidenceNode</a>;</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">typedef</span> <span class="c-code__keyword">struct </span>shared_string_node_t <a name="_a6"></a><a class="code" href="structshared_string_node.html">sharedStringNode</a>;</div><div class="c-code__line"><span class="c-code__keyword">typedef</span> <span class="c-code__keyword">struct </span>shared_string_node_t {</div><div class="c-code__line">    <span class="c-code__keyword">const</span> <span class="c-code__keywordtype">char</span>* value;</div><div class="c-code__line">    <span class="c-code__keywordtype">size_t</span> length;</div><div class="c-code__line">    <a class="code" href="structshared_string_node.html">sharedStringNode</a>* next;</div><div class="c-code__line">} <a class="code" href="structshared_string_node.html">sharedStringNode</a>;</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">typedef</span> <span class="c-code__keyword">struct </span>performanceState_t {</div><div class="c-code__line">    <span class="c-code__comment">// Where the results of the tests are gathered</span></div><div class="c-code__line">    <a class="code" href="structbenchmark_result.html">benchmarkResult</a>* resultList;</div><div class="c-code__line">    <span class="c-code__comment">// Number of concurrent threads to benchmark</span></div><div class="c-code__line">    uint16_t numberOfThreads;</div><div class="c-code__line">    <span class="c-code__comment">// Pointer to the first item of evidence available.</span></div><div class="c-code__line">    <a class="code" href="structevidence_node.html">evidenceNode</a>* evidenceFirst;</div><div class="c-code__line">    <span class="c-code__comment">// Pointer to the last item of evidence available.</span></div><div class="c-code__line">    <a class="code" href="structevidence_node.html">evidenceNode</a>* evidenceLast;</div><div class="c-code__line">    <span class="c-code__comment">// Pointer to the first shared string.</span></div><div class="c-code__line">    <a class="code" href="structshared_string_node.html">sharedStringNode</a>* sharedStringFirst;</div><div class="c-code__line">    <span class="c-code__comment">// Pointer to the last shared string.</span></div><div class="c-code__line">    <a class="code" href="structshared_string_node.html">sharedStringNode</a>* sharedStringLast;</div><div class="c-code__line">    <span class="c-code__comment">// Number of sets of evidence in the evidence array</span></div><div class="c-code__line">    <span class="c-code__keywordtype">int</span> evidenceCount;</div><div class="c-code__line">    <span class="c-code__comment">// Number of sets of evidence to process</span></div><div class="c-code__line">    <span class="c-code__keywordtype">int</span> iterationsPerThread;</div><div class="c-code__line">    <span class="c-code__comment">// Location of the 51Degrees data file</span></div><div class="c-code__line">    <span class="c-code__keyword">const</span> <span class="c-code__keywordtype">char</span>* dataFileLocation;</div><div class="c-code__line">    <span class="c-code__comment">// File pointer to write output to, usually stdout</span></div><div class="c-code__line">    FILE* output;</div><div class="c-code__line">    <span class="c-code__comment">// File pointer to write results to, usually null</span></div><div class="c-code__line">    FILE* resultsOutput;</div><div class="c-code__line">    <span class="c-code__comment">// Manager containing the dataset</span></div><div class="c-code__line">    <a name="_a7"></a><a class="code" href="structfiftyone_degrees_resource_manager.html">ResourceManager</a> manager;</div><div class="c-code__line">    <span class="c-code__comment">// Running threads</span></div><div class="c-code__line">    <a name="a8"></a><a class="code" href="group___fifty_one_degrees_threading.html#ga73811e87d8e1da7f10bc3943591333ec">FIFTYONE_DEGREES_THREAD</a>* threads;</div><div class="c-code__line">    <span class="c-code__comment">// Time in millis to startup the device detection component.</span></div><div class="c-code__line">    <span class="c-code__keywordtype">double</span> startUpMillis;</div><div class="c-code__line">    <span class="c-code__comment">// Number of property values retrieved for each iteration.</span></div><div class="c-code__line">    <span class="c-code__keywordtype">int</span> availableProperties;</div><div class="c-code__line">    <span class="c-code__comment">// Max number of evidence key values pairs that will be processed.</span></div><div class="c-code__line">    <span class="c-code__keywordtype">int</span> maxEvidence;</div><div class="c-code__line">} <a name="_a9"></a><a class="code" href="structperformance_state.html">performanceState</a>;</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">typedef</span> <span class="c-code__keyword">struct </span>threadState_t {</div><div class="c-code__line">    <span class="c-code__comment">// The main state containing the dataset.</span></div><div class="c-code__line">    <a class="code" href="structperformance_state.html">performanceState</a>* mainState;</div><div class="c-code__line">    <span class="c-code__comment">// The result for this thread within mainState-&gt;resultList.</span></div><div class="c-code__line">    <a class="code" href="structbenchmark_result.html">benchmarkResult</a>* result;</div><div class="c-code__line">} <a name="_a10"></a><a class="code" href="structthread_state.html">threadState</a>;</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">static</span> <span class="c-code__keyword">const</span> <span class="c-code__keywordtype">char</span>* getOrAddSharedString(</div><div class="c-code__line">    <a class="code" href="structperformance_state.html">performanceState</a>* perfState, </div><div class="c-code__line">    <span class="c-code__keyword">const</span> <span class="c-code__keywordtype">char</span>* target) {</div><div class="c-code__line">    <a class="code" href="structshared_string_node.html">sharedStringNode</a>* node = perfState-&gt;<a name="a11"></a>sharedStringFirst;</div><div class="c-code__line">    <span class="c-code__keywordflow">while</span> (node != NULL) {</div><div class="c-code__line">        <span class="c-code__keywordflow">if</span> (strcmp(target, node-&gt;<a name="a12"></a>value) == 0) {</div><div class="c-code__line">            <span class="c-code__keywordflow">return</span> node-&gt;value;</div><div class="c-code__line">        }</div><div class="c-code__line">        node = node-&gt;<a name="a13"></a>next;</div><div class="c-code__line">    }</div><div class="c-code__line">    </div><div class="c-code__line">    <span class="c-code__comment">// Create a new node to add to the head of the list.</span></div><div class="c-code__line">    <span class="c-code__keywordtype">size_t</span> length = strlen(target) + 1;</div><div class="c-code__line">    node = (<a class="code" href="structshared_string_node.html">sharedStringNode</a>*)<a name="a14"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#gac35c76ff5632479d21272251b078a1d4">Malloc</a>(<span class="c-code__keyword">sizeof</span>(<a class="code" href="structshared_string_node.html">sharedStringNode</a>));</div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (node == NULL) {</div><div class="c-code__line">        <span class="c-code__keywordflow">return</span> NULL;</div><div class="c-code__line">    }</div><div class="c-code__line">    node-&gt;next = NULL;</div><div class="c-code__line">    node-&gt;value = (<span class="c-code__keyword">const</span> <span class="c-code__keywordtype">char</span>*)<a class="code" href="group___fifty_one_degrees_synonyms.html#gac35c76ff5632479d21272251b078a1d4">Malloc</a>(<span class="c-code__keyword">sizeof</span>(<span class="c-code__keywordtype">char</span>) * length);</div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (node-&gt;value == NULL) {</div><div class="c-code__line">        <span class="c-code__keywordflow">return</span> NULL;</div><div class="c-code__line">    }</div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (strncpy((<span class="c-code__keywordtype">char</span>*)node-&gt;value, target, length) == NULL) {</div><div class="c-code__line">        <span class="c-code__keywordflow">return</span> NULL;</div><div class="c-code__line">    }</div><div class="c-code__line">    </div><div class="c-code__line">    <span class="c-code__comment">// Add to the linked list or start a new linked list if this is the first.</span></div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (perfState-&gt;sharedStringFirst == NULL) {</div><div class="c-code__line">        perfState-&gt;sharedStringFirst = node;</div><div class="c-code__line">        perfState-&gt;<a name="a15"></a>sharedStringLast = node;</div><div class="c-code__line">    }</div><div class="c-code__line">    <span class="c-code__keywordflow">else</span> {</div><div class="c-code__line">        perfState-&gt;sharedStringLast-&gt;next = node;</div><div class="c-code__line">        perfState-&gt;sharedStringLast = node;</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Return the string from the node.</span></div><div class="c-code__line">    <span class="c-code__keywordflow">return</span> node-&gt;value;</div><div class="c-code__line">}</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keyword">static</span> <span class="c-code__keywordtype">void</span> storeEvidence(<a name="_a16"></a><a class="code" href="structfiftyone_degrees_key_value_pair.html">KeyValuePair</a>* pairs, uint16_t size, <span class="c-code__keywordtype">void</span>* state) {</div><div class="c-code__line">    <a name="a17"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#ga29a7b1eb8b59c26629548b1de83b473b">EXCEPTION_CREATE</a>;</div><div class="c-code__line">    <span class="c-code__keywordtype">char</span>* ptr;</div><div class="c-code__line">    <a class="code" href="structperformance_state.html">performanceState</a>* perfState = (<a class="code" href="structperformance_state.html">performanceState</a>*)state;</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Allocate space for this node and the evidence.</span></div><div class="c-code__line">    <a class="code" href="structevidence_node.html">evidenceNode</a>* node = (<a class="code" href="structevidence_node.html">evidenceNode</a>*)<a class="code" href="group___fifty_one_degrees_synonyms.html#gac35c76ff5632479d21272251b078a1d4">Malloc</a>(<span class="c-code__keyword">sizeof</span>(<a class="code" href="structevidence_node.html">evidenceNode</a>));</div><div class="c-code__line">    node-&gt;<a name="a18"></a>next = NULL;</div><div class="c-code__line">    <a class="code" href="structfiftyone_degrees_evidence_key_value_pair_array.html">EvidenceKeyValuePairArray</a>* <a name="_a19"></a><a class="code" href="structevidence.html">evidence</a> = <a name="a20"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#ga324c123e74727b62612edeead5d0f6a6">EvidenceCreate</a>(size);</div><div class="c-code__line">    node-&gt;<a name="a21"></a>array = <a class="code" href="structevidence.html">evidence</a>;</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Add the evidence node to the linked list of evidence nodes.</span></div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (perfState-&gt;<a name="a22"></a>evidenceFirst == NULL) {</div><div class="c-code__line">        perfState-&gt;evidenceFirst = node;</div><div class="c-code__line">        perfState-&gt;<a name="a23"></a>evidenceLast = node;</div><div class="c-code__line">    }</div><div class="c-code__line">    <span class="c-code__keywordflow">else</span> {</div><div class="c-code__line">        perfState-&gt;evidenceLast-&gt;next = node;</div><div class="c-code__line">        perfState-&gt;evidenceLast = node;</div><div class="c-code__line">    }   </div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Get the target pair that was just allocated.</span></div><div class="c-code__line">    <span class="c-code__keywordflow">for</span> (uint32_t i = 0; i &lt; size; i++) {</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// Set prefix for the key.</span></div><div class="c-code__line">        <a name="_a24"></a><a class="code" href="structfiftyone_degrees_evidence_prefix_map.html">EvidencePrefixMap</a>* prefix = <a name="a25"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#gaf31a20347d083f97ecfffc854487c2fc">EvidenceMapPrefix</a>(pairs[i].key);</div><div class="c-code__line">        <span class="c-code__keywordflow">if</span> (prefix != NULL) {</div><div class="c-code__line">            <a class="code" href="structevidence.html">evidence</a>-&gt;<a name="a26"></a>items[i].<a name="a27"></a>prefix = prefix-&gt;<a name="a28"></a><a class="code" href="structfiftyone_degrees_evidence_prefix_map.html#a8cb7654e0cd2014834d7da1a9217a10d">prefixEnum</a>;</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Get a shared string for the field name without the prefix and </span></div><div class="c-code__line">            <span class="c-code__comment">// use this. Reduces memory consumption as there are only a limited</span></div><div class="c-code__line">            <span class="c-code__comment">// number of keys.</span></div><div class="c-code__line">            <a class="code" href="structevidence.html">evidence</a>-&gt;items[i].field = getOrAddSharedString(</div><div class="c-code__line">                perfState, </div><div class="c-code__line">                pairs[i].key + prefix-&gt;<a name="a29"></a><a class="code" href="structfiftyone_degrees_evidence_prefix_map.html#ab97e3de2bca265436f4552ecae6d6c28">prefixLength</a>);</div><div class="c-code__line">            <span class="c-code__keywordflow">if</span> (<a class="code" href="structevidence.html">evidence</a>-&gt;items[i].field == NULL) {</div><div class="c-code__line">                <a name="a30"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#ga1d1a54ffb69cad881269379cc5af3f35">EXCEPTION_THROW</a></div><div class="c-code__line">            }</div><div class="c-code__line">        }</div><div class="c-code__line">        <span class="c-code__keywordflow">else</span> {</div><div class="c-code__line">            <a class="code" href="structevidence.html">evidence</a>-&gt;items[i].prefix = <a name="a31"></a><a class="code" href="group___fifty_one_degrees_evidence.html#gga1ff9010650f2716970e86c12c5a97a76a61b6045bdab8eb5b4aca237971e00b9d">FIFTYONE_DEGREES_EVIDENCE_IGNORE</a>;</div><div class="c-code__line">            <a class="code" href="structevidence.html">evidence</a>-&gt;items[i].field = NULL;</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// If the field is User-Agent or NULL then create new memory for the </span></div><div class="c-code__line">        <span class="c-code__comment">// string value, otherwise use shared strings.</span></div><div class="c-code__line">        <span class="c-code__keywordflow">if</span> (<a class="code" href="structevidence.html">evidence</a>-&gt;items[i].field == NULL ||</div><div class="c-code__line">            strcmp(<a class="code" href="structevidence.html">evidence</a>-&gt;items[i].field, userAgent) == 0) {</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Copy the value to new memory at the original value, and then set</span></div><div class="c-code__line">            <span class="c-code__comment">// the parsed value to point to the original value. This memory </span></div><div class="c-code__line">            <span class="c-code__comment">// will be freed after the test.</span></div><div class="c-code__line">            <a class="code" href="structevidence.html">evidence</a>-&gt;items[i].originalValue = (<span class="c-code__keyword">const</span> <span class="c-code__keywordtype">char</span>*)<a class="code" href="group___fifty_one_degrees_synonyms.html#gac35c76ff5632479d21272251b078a1d4">Malloc</a>(</div><div class="c-code__line">                <span class="c-code__keyword">sizeof</span>(<span class="c-code__keywordtype">char</span>) * (pairs[i].<a name="a32"></a>valueLength + 1));</div><div class="c-code__line">            ptr = strncpy(</div><div class="c-code__line">                (<span class="c-code__keywordtype">char</span>*)<a class="code" href="structevidence.html">evidence</a>-&gt;items[i].originalValue,</div><div class="c-code__line">                pairs[i].<a name="a33"></a>value,</div><div class="c-code__line">                pairs[i].valueLength);</div><div class="c-code__line">            <span class="c-code__keywordflow">if</span> (ptr == NULL) {</div><div class="c-code__line">                <a class="code" href="group___fifty_one_degrees_synonyms.html#ga1d1a54ffb69cad881269379cc5af3f35">EXCEPTION_THROW</a></div><div class="c-code__line">            }</div><div class="c-code__line">            <a class="code" href="structevidence.html">evidence</a>-&gt;items[i].parsedValue = <a class="code" href="structevidence.html">evidence</a>-&gt;items[i].originalValue;</div><div class="c-code__line">        }</div><div class="c-code__line">        <span class="c-code__keywordflow">else</span> {</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__comment">// Set the parsed value to the shared string value and set the </span></div><div class="c-code__line">            <span class="c-code__comment">// original value to NULL to indicate there is no memory to be </span></div><div class="c-code__line">            <span class="c-code__comment">// freed after the performance test.</span></div><div class="c-code__line">            <a class="code" href="structevidence.html">evidence</a>-&gt;items[i].parsedValue = getOrAddSharedString(</div><div class="c-code__line">                perfState,</div><div class="c-code__line">                pairs[i].value);</div><div class="c-code__line">            <span class="c-code__keywordflow">if</span> (<a class="code" href="structevidence.html">evidence</a>-&gt;items[i].parsedValue == NULL) {</div><div class="c-code__line">                <a class="code" href="group___fifty_one_degrees_synonyms.html#ga1d1a54ffb69cad881269379cc5af3f35">EXCEPTION_THROW</a></div><div class="c-code__line">            }</div><div class="c-code__line">            <a class="code" href="structevidence.html">evidence</a>-&gt;items[i].originalValue = NULL;</div><div class="c-code__line">        }</div><div class="c-code__line">    }</div><div class="c-code__line">    <a class="code" href="structevidence.html">evidence</a>-&gt;<a name="a34"></a>count = size;</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Set the maximum capacity needed in evidence if higher.</span></div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (size &gt; perfState-&gt;<a name="a35"></a>maxEvidence) {</div><div class="c-code__line">        perfState-&gt;maxEvidence = size;</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Increment the total evidence count.</span></div><div class="c-code__line">    perfState-&gt;<a name="a36"></a>evidenceCount++;</div><div class="c-code__line">}</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keywordtype">void</span> runPerformanceThread(<span class="c-code__keywordtype">void</span>* state) {</div><div class="c-code__line">    <a class="code" href="group___fifty_one_degrees_synonyms.html#ga29a7b1eb8b59c26629548b1de83b473b">EXCEPTION_CREATE</a>;</div><div class="c-code__line">    <a name="_a37"></a><a class="code" href="structfiftyone_degrees_string.html">String</a>* value;</div><div class="c-code__line">    <a class="code" href="structthread_state.html">threadState</a> *thisState = (<a class="code" href="structthread_state.html">threadState</a>*)state;</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Create an instance of results to access the returned values.</span></div><div class="c-code__line">    <a name="_a38"></a><a class="code" href="structfiftyone_degrees_result_hash_array.html">ResultsHash</a> *results = <a name="a39"></a><a class="code" href="group___fifty_one_degrees_hash_synonyms.html#ga6eee92bf88015e1e2caba34a2f4589d6">ResultsHashCreate</a>(</div><div class="c-code__line">        &amp;thisState-&gt;<a name="a40"></a>mainState-&gt;<a name="a41"></a>manager,</div><div class="c-code__line">        thisState-&gt;mainState-&gt;maxEvidence,</div><div class="c-code__line">        thisState-&gt;mainState-&gt;maxEvidence);</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Reference to the dataset.</span></div><div class="c-code__line">    <a name="_a42"></a><a class="code" href="structfiftyone_degrees_data_set_hash.html">DataSetHash</a>* dataSet = (<a class="code" href="structfiftyone_degrees_data_set_hash.html">DataSetHash</a>*)results-&gt;<a name="a43"></a><a class="code" href="structfiftyone_degrees_result_hash_array.html#a0b613284cd3b79bbcb76cd694b77ac91">b</a>.<a name="a44"></a><a class="code" href="structfiftyone_degrees_results_device_detection.html#ab274eced26b8fd68a8170b27dac75dde">b</a>.<a name="a45"></a><a class="code" href="structfiftyone_degrees_results_base.html#acb1eb8a8fb245ea49299b19fd71fa1d5">dataSet</a>;</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Thread specific evidence instance.</span></div><div class="c-code__line">    <a class="code" href="structfiftyone_degrees_evidence_key_value_pair_array.html">EvidenceKeyValuePairArray</a>* <a class="code" href="structevidence.html">evidence</a> = <a class="code" href="group___fifty_one_degrees_synonyms.html#ga324c123e74727b62612edeead5d0f6a6">EvidenceCreate</a>(</div><div class="c-code__line">        thisState-&gt;mainState-&gt;maxEvidence);</div><div class="c-code__line"></div><div class="c-code__line">    TIMER_CREATE;</div><div class="c-code__line">    TIMER_START;</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Execute the performance test moving through the linked list.</span></div><div class="c-code__line">    <a class="code" href="structevidence_node.html">evidenceNode</a>* node = thisState-&gt;mainState-&gt;evidenceFirst;</div><div class="c-code__line">    <span class="c-code__keywordflow">while</span>(node != NULL) {</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// The evidence data structure has a field for pseudoEvidence which is</span></div><div class="c-code__line">        <span class="c-code__comment">// modified during processing. Therefore the node in the list can&#39;t</span></div><div class="c-code__line">        <span class="c-code__comment">// be used directly as it might be in use by another thread. Therefore</span></div><div class="c-code__line">        <span class="c-code__comment">// copy the immutable members of the evidence node.</span></div><div class="c-code__line">        *<a class="code" href="structevidence.html">evidence</a> = *node-&gt;array;</div><div class="c-code__line"></div><div class="c-code__line">        <a name="a46"></a><a class="code" href="group___fifty_one_degrees_hash_synonyms.html#ga3695959f3706c2b267ad02133aab0f7b">ResultsHashFromEvidence</a>(results, <a class="code" href="structevidence.html">evidence</a>, exception);</div><div class="c-code__line">        <a class="code" href="group___fifty_one_degrees_synonyms.html#ga1d1a54ffb69cad881269379cc5af3f35">EXCEPTION_THROW</a>;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// Get the all properties from the results if this is part of the</span></div><div class="c-code__line">        <span class="c-code__comment">// performance evaluation.</span></div><div class="c-code__line">        <span class="c-code__keywordflow">for</span> (uint32_t j = 0; j &lt; dataSet-&gt;<a name="a47"></a><a class="code" href="structfiftyone_degrees_data_set_hash.html#a55d7db87af4c400bca7d04581a95b533">b</a>.<a name="a48"></a><a class="code" href="structfiftyone_degrees_data_set_device_detection.html#a69c6c6bb7cf4fea8d484e3dbe01053fb">b</a>.<a name="a49"></a><a class="code" href="structfiftyone_degrees_data_set_base.html#afb6fe7080fd386b7b4233ce5c87ce3c2">available</a>-&gt;<a name="a50"></a><a class="code" href="structfiftyone_degrees_property_available_array.html#a931e016a455f0ace924c2df65db6a54e">count</a>; j++) {</div><div class="c-code__line">            <span class="c-code__keywordflow">if</span> (<a name="a51"></a><a class="code" href="group___fifty_one_degrees_hash_synonyms.html#ga38d3d8dfbf77973f881b25688b74c1dd">ResultsHashGetValues</a>(</div><div class="c-code__line">                results,</div><div class="c-code__line">                j,</div><div class="c-code__line">                exception) != NULL &amp;&amp; <a name="a52"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#ga7ad7ecba8293409ee538458c83fbd23e">EXCEPTION_OKAY</a>) {</div><div class="c-code__line">                value = (<a class="code" href="structfiftyone_degrees_string.html">String</a>*)results-&gt;<a name="a53"></a><a class="code" href="structfiftyone_degrees_result_hash_array.html#a6c96e5cfbf7a07553a1635295ef7dc9b">values</a>.<a name="a54"></a><a class="code" href="structfiftyone_degrees_list.html#ab3a44dccc98b7e90598986ae34c10dbe">items</a>[0].<a name="a55"></a><a class="code" href="structfiftyone_degrees_collection_item.html#a2a6c691d3e58694438f2b5575a2d7f08">data</a>.<a name="a56"></a><a class="code" href="structfiftyone_degrees_data.html#a838d52f2eb8fdc33d239ce30fe4f1fe5">ptr</a>;</div><div class="c-code__line">                if (value != NULL) {</div><div class="c-code__line">                    <span class="c-code__comment">// Increase the checksum with the size of the string to </span></div><div class="c-code__line">                    <span class="c-code__comment">// provide a crude checksum.</span></div><div class="c-code__line">                    thisState-&gt;<a name="a57"></a>result-&gt;<a name="a58"></a>checkSum += value-&gt;<a name="a59"></a><a class="code" href="structfiftyone_degrees_string.html#a19edbe774286b70a861f435b28a7117f">size</a>;</div><div class="c-code__line">                }</div><div class="c-code__line">            }</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// Increase the count.</span></div><div class="c-code__line">        thisState-&gt;result-&gt;<a name="a60"></a>count++;</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// Move to the next node.</span></div><div class="c-code__line">        node = node-&gt;next;</div><div class="c-code__line">    }</div><div class="c-code__line">    </div><div class="c-code__line">    TIMER_END;</div><div class="c-code__line">    </div><div class="c-code__line">    <a name="a61"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#gac0d0435d95ea76ed3ee71c0348b3be81">EvidenceFree</a>(<a class="code" href="structevidence.html">evidence</a>);</div><div class="c-code__line">    <a name="a62"></a><a class="code" href="group___fifty_one_degrees_hash_synonyms.html#gaef12979129e46a5fd7ebb6be8867a88d">ResultsHashFree</a>(results);</div><div class="c-code__line"></div><div class="c-code__line">    thisState-&gt;result-&gt;<a name="a63"></a>elapsedMillis = TIMER_ELAPSED;</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (<a name="a64"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#ga03649d9fd49fb4489d4728fb70fa404b">ThreadingGetIsThreadSafe</a>()) {</div><div class="c-code__line">        <a name="a65"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#gae6cf42265fe26b84cec6c05b498a7b7c">THREAD_EXIT</a>;</div><div class="c-code__line">    }</div><div class="c-code__line">}</div><div class="c-code__line"><span class="c-code__keywordtype">double</span> runTests(<a class="code" href="structperformance_state.html">performanceState</a> *state) {</div><div class="c-code__line">    <span class="c-code__comment">// Initialize states for each thread.</span></div><div class="c-code__line">    <a class="code" href="structthread_state.html">threadState</a>* states = (<a class="code" href="structthread_state.html">threadState</a>*)</div><div class="c-code__line">        <a class="code" href="group___fifty_one_degrees_synonyms.html#gac35c76ff5632479d21272251b078a1d4">Malloc</a>(<span class="c-code__keyword">sizeof</span>(<a class="code" href="structthread_state.html">threadState</a>) * state-&gt;<a name="a66"></a>numberOfThreads);</div><div class="c-code__line">    <span class="c-code__keywordflow">for</span> (<span class="c-code__keywordtype">int</span> i = 0; i &lt; state-&gt;numberOfThreads; i++) {</div><div class="c-code__line">        states[i].mainState = state;</div><div class="c-code__line">        states[i].result = &amp;state-&gt;<a name="a67"></a>resultList[i];</div><div class="c-code__line">        states[i].result-&gt;checkSum = 0;</div><div class="c-code__line">        states[i].result-&gt;count = 0;</div><div class="c-code__line">        states[i].result-&gt;elapsedMillis = 0;</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keywordtype">int</span> thread;</div><div class="c-code__line"></div><div class="c-code__line">    TIMER_CREATE;</div><div class="c-code__line">    TIMER_START;</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (<a class="code" href="group___fifty_one_degrees_synonyms.html#ga03649d9fd49fb4489d4728fb70fa404b">ThreadingGetIsThreadSafe</a>()) {</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// Create and start the threads.</span></div><div class="c-code__line">        <span class="c-code__keywordflow">for</span> (thread = 0; thread &lt; state-&gt;numberOfThreads; thread++) {</div><div class="c-code__line">            <a name="a68"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#gaa519320c3a94b1baf8495a3c45686b01">THREAD_CREATE</a>(</div><div class="c-code__line">                state-&gt;<a name="a69"></a>threads[thread],</div><div class="c-code__line">                (<a name="a70"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#gac3b1b7914c03617e93bcc720b3b63535">THREAD_ROUTINE</a>)&amp;runPerformanceThread,</div><div class="c-code__line">                &amp;states[thread]);</div><div class="c-code__line">        }</div><div class="c-code__line"></div><div class="c-code__line">        <span class="c-code__comment">// Wait for them to finish.</span></div><div class="c-code__line">        <span class="c-code__keywordflow">for</span> (thread = 0; thread &lt; state-&gt;numberOfThreads; thread++) {</div><div class="c-code__line">            <a name="a71"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#ga8780bffcae60e8593485d281e4914545">THREAD_JOIN</a>(state-&gt;threads[thread]);</div><div class="c-code__line">            <a name="a72"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#gad09cd47e11c1d05e201237e0deadd1d2">THREAD_CLOSE</a>(state-&gt;threads[thread]);</div><div class="c-code__line">        }</div><div class="c-code__line">    }</div><div class="c-code__line">    <span class="c-code__keywordflow">else</span> {</div><div class="c-code__line">        fprintf(state-&gt;<a name="a73"></a>output, <span class="c-code__stringliteral">&quot;Example not build with multi threading support.\n&quot;</span>);</div><div class="c-code__line">        runPerformanceThread(&amp;states[0]);</div><div class="c-code__line">    }</div><div class="c-code__line">    TIMER_END;</div><div class="c-code__line">    <a name="a74"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#gae0ecd1fc988dbb64ff0232a001e090bf">Free</a>(states);</div><div class="c-code__line">    <span class="c-code__keywordflow">return</span> TIMER_ELAPSED;</div><div class="c-code__line">}</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keywordtype">void</span> doReport(<a class="code" href="structperformance_state.html">performanceState</a> *state) {</div><div class="c-code__line">    <span class="c-code__keywordtype">double</span> totalMillis = 0;</div><div class="c-code__line">    <span class="c-code__keywordtype">long</span> totalChecks = 0;</div><div class="c-code__line">    <span class="c-code__keywordtype">long</span> checksum = 0;</div><div class="c-code__line">    <span class="c-code__keywordflow">for</span> (<span class="c-code__keywordtype">int</span> i = 0; i &lt; state-&gt;numberOfThreads; i++) {</div><div class="c-code__line">        <a class="code" href="structbenchmark_result.html">benchmarkResult</a> *result = &amp;state-&gt;resultList[i];</div><div class="c-code__line">        fprintf(state-&gt;output,</div><div class="c-code__line">            <span class="c-code__stringliteral">&quot;Thread: %ld detections, elapsed %.3f seconds, %.0lf Detections per second\n&quot;</span>,</div><div class="c-code__line">            result-&gt;count,</div><div class="c-code__line">            result-&gt;elapsedMillis / 1000.0,</div><div class="c-code__line">            round(1000.0 * result-&gt;count / result-&gt;elapsedMillis));</div><div class="c-code__line"></div><div class="c-code__line">        totalMillis += result-&gt;elapsedMillis;</div><div class="c-code__line">        totalChecks += result-&gt;count;</div><div class="c-code__line">        checksum += result-&gt;checkSum;</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// output the results from the benchmark to the console</span></div><div class="c-code__line">    <span class="c-code__keywordtype">double</span> millisPerTest = ((double)totalMillis / (state-&gt;numberOfThreads * totalChecks));</div><div class="c-code__line">    fprintf(state-&gt;output,</div><div class="c-code__line">        <span class="c-code__stringliteral">&quot;Overall: %ld detections, Average ms per detection: %f, Detections per second: %.0lf\n&quot;</span>,</div><div class="c-code__line">        totalChecks,</div><div class="c-code__line">        millisPerTest,</div><div class="c-code__line">        round(1000.0 / millisPerTest));</div><div class="c-code__line">    fprintf(state-&gt;output,</div><div class="c-code__line">        <span class="c-code__stringliteral">&quot;Overall: Concurrent threads: %d, Checksum: %lx\n&quot;</span>,</div><div class="c-code__line">        state-&gt;numberOfThreads,</div><div class="c-code__line">        checksum);</div><div class="c-code__line">    fprintf(state-&gt;output,</div><div class="c-code__line">        <span class="c-code__stringliteral">&quot;Overall: Startup ms %.0lf\n&quot;</span>,</div><div class="c-code__line">        state-&gt;<a name="a75"></a>startUpMillis);</div><div class="c-code__line">    fprintf(state-&gt;output,</div><div class="c-code__line">        <span class="c-code__stringliteral">&quot;Overall: Properties retrieved %d\n&quot;</span>,</div><div class="c-code__line">        state-&gt;<a name="a76"></a>availableProperties);</div><div class="c-code__line">    fprintf(state-&gt;output, <span class="c-code__stringliteral">&quot;\n&quot;</span>);</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (state-&gt;<a name="a77"></a>resultsOutput != NULL) {</div><div class="c-code__line">        fprintf(state-&gt;resultsOutput, <span class="c-code__stringliteral">&quot;  \&quot;DetectionsPerSecond\&quot;: %.2f,\n&quot;</span>, round(1000.0 / millisPerTest));</div><div class="c-code__line">        fprintf(state-&gt;resultsOutput, <span class="c-code__stringliteral">&quot;  \&quot;StartupMs\&quot;: %.0lf,\n&quot;</span>, state-&gt;startUpMillis);</div><div class="c-code__line">    }</div><div class="c-code__line">}</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keywordtype">void</span> executeBenchmark(</div><div class="c-code__line">    <a class="code" href="structperformance_state.html">performanceState</a> *state,</div><div class="c-code__line">    <a class="code" href="structperformance_config.html">performanceConfig</a> config) {</div><div class="c-code__line">    <span class="c-code__comment">// Make a local copy of the config as we&#39;re going to alter it a bit.</span></div><div class="c-code__line">    <a class="code" href="structfiftyone_degrees_config_hash.html">ConfigHash</a> dataSetConfig = *config.<a name="a78"></a>config;</div><div class="c-code__line">    fprintf(state-&gt;output, </div><div class="c-code__line">        <span class="c-code__stringliteral">&quot;Benchmarking with profile: %s AllProperties: %s\n&quot;</span>,</div><div class="c-code__line">        fiftyoneDegreesExampleGetConfigName(dataSetConfig),</div><div class="c-code__line">        config.<a name="a79"></a>allProperties ? <span class="c-code__stringliteral">&quot;True&quot;</span> : <span class="c-code__stringliteral">&quot;False&quot;</span>);</div><div class="c-code__line">    </div><div class="c-code__line">    <a class="code" href="group___fifty_one_degrees_synonyms.html#ga29a7b1eb8b59c26629548b1de83b473b">EXCEPTION_CREATE</a>;</div><div class="c-code__line"></div><div class="c-code__line">    <a name="_a80"></a><a class="code" href="structfiftyone_degrees_properties_required.html">PropertiesRequired</a> properties = <a name="a81"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#ga246be0840df800ead0edc55949e2e92e">PropertiesDefault</a>;</div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (config.allProperties == <span class="c-code__keyword">false</span>) {</div><div class="c-code__line">        properties.<a name="a82"></a><a class="code" href="structfiftyone_degrees_properties_required.html#a7044785e8c67e2d208ba1010ec355d5c">string</a> = <span class="c-code__stringliteral">&quot;IsMobile&quot;</span>;</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Multi graph operation is being deprecated. There is only one graph.</span></div><div class="c-code__line">    dataSetConfig.<a name="a83"></a><a class="code" href="structfiftyone_degrees_config_hash.html#a23615bfc3fabe841a85093fb24315a25">usePerformanceGraph</a> = <span class="c-code__keyword">false</span>;</div><div class="c-code__line">    dataSetConfig.<a name="a84"></a><a class="code" href="structfiftyone_degrees_config_hash.html#a3c817851ab2952d5e98c9d1b8a7c20d4">usePredictiveGraph</a> = <span class="c-code__keyword">true</span>;</div><div class="c-code__line"></div><div class="c-code__line">    dataSetConfig.<a name="a85"></a><a class="code" href="structfiftyone_degrees_config_hash.html#a88936a51b61e8d8caea7050e70dd1a57">strings</a>.<a name="a86"></a><a class="code" href="structfiftyone_degrees_collection_config.html#af3dee101ea5b465a0a40f1899487e041">concurrency</a> = state-&gt;numberOfThreads;</div><div class="c-code__line">    dataSetConfig.<a name="a87"></a><a class="code" href="structfiftyone_degrees_config_hash.html#a49e425bb6e974965fd49cd01e95822f1">properties</a>.<a class="code" href="structfiftyone_degrees_collection_config.html#af3dee101ea5b465a0a40f1899487e041">concurrency</a> = state-&gt;numberOfThreads;</div><div class="c-code__line">    dataSetConfig.<a name="a88"></a><a class="code" href="structfiftyone_degrees_config_hash.html#a63f3eaf0a39943fd2ebd4f1ee814d5f7">values</a>.<a class="code" href="structfiftyone_degrees_collection_config.html#af3dee101ea5b465a0a40f1899487e041">concurrency</a> = state-&gt;numberOfThreads;</div><div class="c-code__line">    dataSetConfig.<a name="a89"></a><a class="code" href="structfiftyone_degrees_config_hash.html#acd156b439ec81a3f3f417e9042bcf60a">profiles</a>.<a class="code" href="structfiftyone_degrees_collection_config.html#af3dee101ea5b465a0a40f1899487e041">concurrency</a> = state-&gt;numberOfThreads;</div><div class="c-code__line">    dataSetConfig.<a name="a90"></a><a class="code" href="structfiftyone_degrees_config_hash.html#a5476be1948230837b742d4feb2c58281">nodes</a>.<a class="code" href="structfiftyone_degrees_collection_config.html#af3dee101ea5b465a0a40f1899487e041">concurrency</a> = state-&gt;numberOfThreads;</div><div class="c-code__line">    dataSetConfig.<a name="a91"></a><a class="code" href="structfiftyone_degrees_config_hash.html#aec1613c07e619680c4141c959b2d0c4f">profileOffsets</a>.<a class="code" href="structfiftyone_degrees_collection_config.html#af3dee101ea5b465a0a40f1899487e041">concurrency</a> = state-&gt;numberOfThreads;</div><div class="c-code__line">    dataSetConfig.<a name="a92"></a><a class="code" href="structfiftyone_degrees_config_hash.html#a2187b84587c7959feb7003ce39c9a75f">maps</a>.<a class="code" href="structfiftyone_degrees_collection_config.html#af3dee101ea5b465a0a40f1899487e041">concurrency</a> = state-&gt;numberOfThreads;</div><div class="c-code__line">    dataSetConfig.<a name="a93"></a><a class="code" href="structfiftyone_degrees_config_hash.html#ae6f2cc08ef87f41faa4e425cc3fb82cb">components</a>.<a class="code" href="structfiftyone_degrees_collection_config.html#af3dee101ea5b465a0a40f1899487e041">concurrency</a> = state-&gt;numberOfThreads;</div><div class="c-code__line"></div><div class="c-code__line">    state-&gt;threads = (<a class="code" href="group___fifty_one_degrees_threading.html#ga73811e87d8e1da7f10bc3943591333ec">FIFTYONE_DEGREES_THREAD</a>*)</div><div class="c-code__line">        <a class="code" href="group___fifty_one_degrees_synonyms.html#gac35c76ff5632479d21272251b078a1d4">Malloc</a>(<span class="c-code__keyword">sizeof</span>(<a class="code" href="group___fifty_one_degrees_threading.html#ga73811e87d8e1da7f10bc3943591333ec">FIFTYONE_DEGREES_THREAD</a>) * state-&gt;numberOfThreads);</div><div class="c-code__line"></div><div class="c-code__line">    fprintf(state-&gt;output, <span class="c-code__stringliteral">&quot;Load from disk\n&quot;</span>);</div><div class="c-code__line">    </div><div class="c-code__line">    TIMER_CREATE;</div><div class="c-code__line">    TIMER_START;</div><div class="c-code__line">    </div><div class="c-code__line">    <a class="code" href="group___fifty_one_degrees_status.html#ga887881c8b6ec9f0c8510913831ebd19e">StatusCode</a> status = <a name="a94"></a><a class="code" href="group___fifty_one_degrees_hash_synonyms.html#gaf32e91a9120e015fb219a3044498f7bc">HashInitManagerFromFile</a>(</div><div class="c-code__line">        &amp;state-&gt;manager,</div><div class="c-code__line">        &amp;dataSetConfig,</div><div class="c-code__line">        &amp;properties,</div><div class="c-code__line">        state-&gt;<a name="a95"></a>dataFileLocation,</div><div class="c-code__line">        exception);</div><div class="c-code__line">    <a class="code" href="group___fifty_one_degrees_synonyms.html#ga1d1a54ffb69cad881269379cc5af3f35">EXCEPTION_THROW</a>;</div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (status != <a name="a96"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>) {</div><div class="c-code__line">        <span class="c-code__keyword">const</span> <span class="c-code__keywordtype">char</span>* message = <a name="a97"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#ga3002890a18e3a86e4078880f2b00bbad">StatusGetMessage</a>(status, state-&gt;dataFileLocation);</div><div class="c-code__line">        fprintf(state-&gt;output, <span class="c-code__stringliteral">&quot;%s\n&quot;</span>, message);</div><div class="c-code__line">        <a class="code" href="group___fifty_one_degrees_synonyms.html#gae0ecd1fc988dbb64ff0232a001e090bf">Free</a>((<span class="c-code__keywordtype">void</span>*)message);</div><div class="c-code__line">        <span class="c-code__keywordflow">return</span>;</div><div class="c-code__line">    }</div><div class="c-code__line">    </div><div class="c-code__line">    TIMER_END;</div><div class="c-code__line">    state-&gt;startUpMillis = TIMER_ELAPSED;</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Check data file</span></div><div class="c-code__line">    <a class="code" href="structfiftyone_degrees_data_set_hash.html">DataSetHash</a>* dataset = <a name="a98"></a><a class="code" href="group___fifty_one_degrees_hash_synonyms.html#gafef8c4d3822ac3c836ded5c4e7c6893c">DataSetHashGet</a>(&amp;state-&gt;manager);</div><div class="c-code__line">    state-&gt;availableProperties = dataset-&gt;<a class="code" href="structfiftyone_degrees_data_set_hash.html#a55d7db87af4c400bca7d04581a95b533">b</a>.<a class="code" href="structfiftyone_degrees_data_set_device_detection.html#a69c6c6bb7cf4fea8d484e3dbe01053fb">b</a>.<a class="code" href="structfiftyone_degrees_data_set_base.html#afb6fe7080fd386b7b4233ce5c87ce3c2">available</a>-&gt;<a class="code" href="structfiftyone_degrees_property_available_array.html#a931e016a455f0ace924c2df65db6a54e">count</a>;</div><div class="c-code__line">    fiftyoneDegreesExampleCheckDataFile(dataset);</div><div class="c-code__line">    <a name="a99"></a><a class="code" href="group___fifty_one_degrees_hash_synonyms.html#ga0bbb756550d43a40372091d4f12f3a7a">DataSetHashRelease</a>(dataset);</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// run the benchmarks twice, once to warm up any caches</span></div><div class="c-code__line">    fprintf(state-&gt;output, <span class="c-code__stringliteral">&quot;Warming up\n&quot;</span>);</div><div class="c-code__line">    runTests(state);</div><div class="c-code__line"></div><div class="c-code__line">    fprintf(state-&gt;output, <span class="c-code__stringliteral">&quot;Running\n&quot;</span>);</div><div class="c-code__line">    <span class="c-code__keywordtype">double</span> executionTime = runTests(state);</div><div class="c-code__line">    fprintf(state-&gt;output,</div><div class="c-code__line">        <span class="c-code__stringliteral">&quot;Finished - Execution time was %lf ms\n&quot;</span>,</div><div class="c-code__line">        executionTime);</div><div class="c-code__line"></div><div class="c-code__line">    <a name="a100"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#gac5094875841e9d95dc972014124ea765">ResourceManagerFree</a>(&amp;state-&gt;manager);</div><div class="c-code__line">    <a class="code" href="group___fifty_one_degrees_synonyms.html#gae0ecd1fc988dbb64ff0232a001e090bf">Free</a>(state-&gt;threads);</div><div class="c-code__line"></div><div class="c-code__line">    doReport(state);</div><div class="c-code__line">}</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keywordtype">void</span> freeEvidence(<a class="code" href="structperformance_state.html">performanceState</a>* state) {</div><div class="c-code__line">    <a class="code" href="structevidence_node.html">evidenceNode</a>* node = state-&gt;evidenceFirst;</div><div class="c-code__line">    <span class="c-code__keywordflow">while</span> (node != NULL) {</div><div class="c-code__line">        <a class="code" href="structfiftyone_degrees_evidence_key_value_pair_array.html">EvidenceKeyValuePairArray</a>* <a class="code" href="structevidence.html">evidence</a> = node-&gt;array;</div><div class="c-code__line">        <span class="c-code__keywordflow">for</span> (uint32_t j = 0; j &lt; <a class="code" href="structevidence.html">evidence</a>-&gt;count; j++) {</div><div class="c-code__line">            <span class="c-code__keywordflow">if</span> (<a class="code" href="structevidence.html">evidence</a>-&gt;items[j].originalValue != NULL) {</div><div class="c-code__line">                <a class="code" href="group___fifty_one_degrees_synonyms.html#gae0ecd1fc988dbb64ff0232a001e090bf">Free</a>((<span class="c-code__keywordtype">void</span>*)<a class="code" href="structevidence.html">evidence</a>-&gt;items[j].originalValue);</div><div class="c-code__line">            }</div><div class="c-code__line">        }</div><div class="c-code__line">        <a class="code" href="group___fifty_one_degrees_synonyms.html#gac0d0435d95ea76ed3ee71c0348b3be81">EvidenceFree</a>(<a class="code" href="structevidence.html">evidence</a>);</div><div class="c-code__line">        <a class="code" href="structevidence_node.html">evidenceNode</a>* next = node-&gt;next;</div><div class="c-code__line">        <a class="code" href="group___fifty_one_degrees_synonyms.html#gae0ecd1fc988dbb64ff0232a001e090bf">Free</a>(node);</div><div class="c-code__line">        node = next;</div><div class="c-code__line">    }</div><div class="c-code__line">}</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keywordtype">void</span> freeSharedStrings(<a class="code" href="structperformance_state.html">performanceState</a>* state) {</div><div class="c-code__line">    <a class="code" href="structshared_string_node.html">sharedStringNode</a>* node = state-&gt;sharedStringFirst;</div><div class="c-code__line">    <span class="c-code__keywordflow">while</span> (node != NULL) {</div><div class="c-code__line">        <a class="code" href="group___fifty_one_degrees_synonyms.html#gae0ecd1fc988dbb64ff0232a001e090bf">Free</a>((<span class="c-code__keywordtype">void</span>*)node-&gt;value);</div><div class="c-code__line">        <a class="code" href="structshared_string_node.html">sharedStringNode</a>* next = node-&gt;next;</div><div class="c-code__line">        <a class="code" href="group___fifty_one_degrees_synonyms.html#gae0ecd1fc988dbb64ff0232a001e090bf">Free</a>(node);</div><div class="c-code__line">        node = next;</div><div class="c-code__line">    }</div><div class="c-code__line">}</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keywordtype">void</span> fiftyoneDegreesHashPerformance(</div><div class="c-code__line">    <span class="c-code__keyword">const</span> <span class="c-code__keywordtype">char</span>* dataFilePath,</div><div class="c-code__line">    <span class="c-code__keyword">const</span> <span class="c-code__keywordtype">char</span>* evidenceFilePath,</div><div class="c-code__line">    uint16_t numberOfThreads,</div><div class="c-code__line">    <span class="c-code__keywordtype">int</span> iterationsPerThread,</div><div class="c-code__line">    FILE* output,</div><div class="c-code__line">    FILE* resultsOutput) {</div><div class="c-code__line">    <a class="code" href="structperformance_state.html">performanceState</a> state;</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Check that the memory only configuration is being used.</span></div><div class="c-code__line">    fprintf(output, <span class="c-code__stringliteral">&quot;Running Performance example - &quot;</span>);</div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (<a name="a101"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#ga1e09607f004644224a45bc6057393de6">CollectionGetIsMemoryOnly</a>()) {</div><div class="c-code__line">        fprintf(output, <span class="c-code__stringliteral">&quot;optimised build\n&quot;</span>);</div><div class="c-code__line">    }</div><div class="c-code__line">    <span class="c-code__keywordflow">else</span> {</div><div class="c-code__line">        fprintf(output, <span class="c-code__stringliteral">&quot;standard build\n&quot;</span>);</div><div class="c-code__line">        printf(<span class="c-code__stringliteral">&quot;\033[0;33m&quot;</span>);</div><div class="c-code__line">        fprintf(</div><div class="c-code__line">            output,</div><div class="c-code__line">            <span class="c-code__stringliteral">&quot;Use FIFTYONE_DEGREES_MEMORY_ONLY directive for optimum &quot;</span> \</div><div class="c-code__line">            <span class="c-code__stringliteral">&quot;performance\n&quot;</span>);</div><div class="c-code__line">        printf(<span class="c-code__stringliteral">&quot;\033[0m&quot;</span>);</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    state.dataFileLocation = dataFilePath;</div><div class="c-code__line">    state.output = output;</div><div class="c-code__line">    state.resultsOutput = resultsOutput;</div><div class="c-code__line">    state.evidenceCount = 0;</div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (<a class="code" href="group___fifty_one_degrees_synonyms.html#ga03649d9fd49fb4489d4728fb70fa404b">ThreadingGetIsThreadSafe</a>()) {</div><div class="c-code__line">        state.numberOfThreads = numberOfThreads;</div><div class="c-code__line">    }</div><div class="c-code__line">    <span class="c-code__keywordflow">else</span> {</div><div class="c-code__line">        state.numberOfThreads = 1;</div><div class="c-code__line">    }</div><div class="c-code__line">    state.resultList = (<a class="code" href="structbenchmark_result.html">benchmarkResult</a>*)</div><div class="c-code__line">        <a class="code" href="group___fifty_one_degrees_synonyms.html#gac35c76ff5632479d21272251b078a1d4">Malloc</a>(<span class="c-code__keyword">sizeof</span>(<a class="code" href="structbenchmark_result.html">benchmarkResult</a>) * numberOfThreads);</div><div class="c-code__line">    state.<a name="a102"></a>iterationsPerThread = iterationsPerThread;</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Allocate working memory for iterating over the YAML evidence source.</span></div><div class="c-code__line">    <span class="c-code__keywordtype">char</span> buffer[MAX_EVIDENCE * (SIZE_OF_KEY + SIZE_OF_VALUE)];</div><div class="c-code__line">    <a class="code" href="structfiftyone_degrees_key_value_pair.html">KeyValuePair</a> pair[MAX_EVIDENCE];</div><div class="c-code__line">    <span class="c-code__keywordtype">char</span> key[MAX_EVIDENCE][SIZE_OF_KEY];</div><div class="c-code__line">    <span class="c-code__keywordtype">char</span> value[MAX_EVIDENCE][SIZE_OF_VALUE];</div><div class="c-code__line">    <span class="c-code__keywordflow">for</span> (<span class="c-code__keywordtype">int</span> i = 0; i &lt; MAX_EVIDENCE; i++) {</div><div class="c-code__line">        pair[i].key = key[i];</div><div class="c-code__line">        pair[i].keyLength = SIZE_OF_KEY;</div><div class="c-code__line">        pair[i].value = value[i];</div><div class="c-code__line">        pair[i].valueLength = SIZE_OF_VALUE;</div><div class="c-code__line">    }</div><div class="c-code__line">    <span class="c-code__comment">// Iterate over the YAML evidence source storing each entry in memory as </span></div><div class="c-code__line">    <span class="c-code__comment">// evidence.</span></div><div class="c-code__line">    fprintf(</div><div class="c-code__line">        state.output,</div><div class="c-code__line">        <span class="c-code__stringliteral">&quot;Reading &#39;%i&#39; evidence records into memory.\n&quot;</span>,</div><div class="c-code__line">        state.iterationsPerThread);</div><div class="c-code__line">    </div><div class="c-code__line">    <span class="c-code__comment">// Set the state to empty default values.</span></div><div class="c-code__line">    state.evidenceCount = 0;</div><div class="c-code__line">    state.maxEvidence = 0;</div><div class="c-code__line">    state.evidenceFirst = NULL;</div><div class="c-code__line">    state.evidenceLast = NULL;</div><div class="c-code__line">    state.sharedStringFirst = NULL;</div><div class="c-code__line">    state.sharedStringLast = NULL;</div><div class="c-code__line"></div><div class="c-code__line">    <a name="a103"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#ga42842fea605fffe276f1733c41434955">YamlFileIterateWithLimit</a>(</div><div class="c-code__line">        evidenceFilePath,</div><div class="c-code__line">        buffer,</div><div class="c-code__line">        <span class="c-code__keyword">sizeof</span>(buffer),</div><div class="c-code__line">        pair,</div><div class="c-code__line">        MAX_EVIDENCE,</div><div class="c-code__line">        state.iterationsPerThread,</div><div class="c-code__line">        &amp;state,</div><div class="c-code__line">        storeEvidence);</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Report the number of evidence records read.</span></div><div class="c-code__line">    fprintf(</div><div class="c-code__line">        state.output,</div><div class="c-code__line">        <span class="c-code__stringliteral">&quot;Read &#39;%i&#39; evidence records into memory.\n&quot;</span>,</div><div class="c-code__line">        state.evidenceCount);</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (state.resultsOutput != NULL) {</div><div class="c-code__line">        fprintf(state.resultsOutput, <span class="c-code__stringliteral">&quot;{&quot;</span>);</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Run the selected benchmarks using the evidence now in memory.</span></div><div class="c-code__line">    <span class="c-code__keywordflow">for</span> (<span class="c-code__keywordtype">int</span> i = 0;</div><div class="c-code__line">        i &lt; (int)(<span class="c-code__keyword">sizeof</span>(performanceConfigs) / <span class="c-code__keyword">sizeof</span>(<a class="code" href="structperformance_config.html">performanceConfig</a>));</div><div class="c-code__line">        i++) {</div><div class="c-code__line">        </div><div class="c-code__line">        <span class="c-code__keywordflow">if</span> (<a name="a104"></a><a class="code" href="group___fifty_one_degrees_collection.html#ga9a59c1f08a995bc400ac12f8ee798fd5">fiftyoneDegreesCollectionGetIsMemoryOnly</a>() == <span class="c-code__keyword">false</span> ||</div><div class="c-code__line">            performanceConfigs[i].config-&gt;<a name="a105"></a><a class="code" href="structfiftyone_degrees_config_hash.html#a7df616c1c12c853ce8042fa41a184f3f">b</a>.<a name="a106"></a><a class="code" href="structfiftyone_degrees_config_device_detection.html#a194c91ad11b9b6a67bcdeb87730edc45">b</a>.<a name="a107"></a><a class="code" href="structfiftyone_degrees_config_base.html#ad262b246482922758cce9ac0eec1460c">allInMemory</a> == <span class="c-code__keyword">true</span>) {</div><div class="c-code__line">            </div><div class="c-code__line">            <span class="c-code__keywordflow">if</span> (state.resultsOutput != NULL) {</div><div class="c-code__line">                fprintf(state.resultsOutput, <span class="c-code__stringliteral">&quot;%s\n\&quot;%s%s\&quot;: {\n&quot;</span>,</div><div class="c-code__line">                    i &gt; 0 ? <span class="c-code__stringliteral">&quot;,&quot;</span> : <span class="c-code__stringliteral">&quot;&quot;</span>,</div><div class="c-code__line">                    fiftyoneDegreesExampleGetConfigName(*(performanceConfigs[i].config)),</div><div class="c-code__line">                    performanceConfigs[i].allProperties ? <span class="c-code__stringliteral">&quot;_All&quot;</span> : <span class="c-code__stringliteral">&quot;&quot;</span>);</div><div class="c-code__line">            }</div><div class="c-code__line"></div><div class="c-code__line">            executeBenchmark(&amp;state, performanceConfigs[i]);</div><div class="c-code__line"></div><div class="c-code__line">            <span class="c-code__keywordflow">if</span> (state.resultsOutput != NULL) {</div><div class="c-code__line">                fprintf(state.resultsOutput, <span class="c-code__stringliteral">&quot;}&quot;</span>);</div><div class="c-code__line">            }</div><div class="c-code__line">        }</div><div class="c-code__line">    }</div><div class="c-code__line">    </div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (state.resultsOutput != NULL) {</div><div class="c-code__line">        fprintf(state.resultsOutput, <span class="c-code__stringliteral">&quot;}\n&quot;</span>);</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Free the memory used by the shared strings.</span></div><div class="c-code__line">    freeSharedStrings(&amp;state);</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Free the memory used for the evidence.</span></div><div class="c-code__line">    freeEvidence(&amp;state);</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__comment">// Free the memory used for output.</span></div><div class="c-code__line">    <a class="code" href="group___fifty_one_degrees_synonyms.html#gae0ecd1fc988dbb64ff0232a001e090bf">Free</a>(state.resultList);</div><div class="c-code__line"></div><div class="c-code__line">    fprintf(output, <span class="c-code__stringliteral">&quot;Finished Performance example\n&quot;</span>);</div><div class="c-code__line">}</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keywordtype">void</span> fiftyoneDegreesExampleCPerformanceRun(ExampleParameters* params) {</div><div class="c-code__line">    <span class="c-code__comment">// Call the actual function.</span></div><div class="c-code__line">    fiftyoneDegreesHashPerformance(</div><div class="c-code__line">        params-&gt;dataFilePath,</div><div class="c-code__line">        params-&gt;evidenceFilePath,</div><div class="c-code__line">        params-&gt;numberOfThreads,</div><div class="c-code__line">        params-&gt;iterationsPerThread,</div><div class="c-code__line">        params-&gt;output,</div><div class="c-code__line">        params-&gt;resultsOutput);</div><div class="c-code__line">}</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__preprocessor">#ifndef TEST</span></div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__preprocessor">#define DATA_OPTION &quot;--data-file&quot;</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define DATA_OPTION_SHORT &quot;-d&quot;</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define UA_OPTION &quot;--user-agent-file&quot;</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define UA_OPTION_SHORT &quot;-u&quot;</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define THREAD_OPTION &quot;--threads&quot;</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define THREAD_OPTION_SHORT &quot;-t&quot;</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define JSON_OPTION &quot;--json-output&quot;</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define JSON_OPTION_SHORT &quot;-j&quot;</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define ITERATIONS_OPTION &quot;--iterations&quot;</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define ITERATIONS_OPTION_SHORT &quot;-i&quot;</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define HELP_OPTION &quot;--help&quot;</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define HELP_OPTION_SHORT &quot;-h&quot;</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define OPTION_PADDING(o) ((int)(30 - strlen(o)))</span></div><div class="c-code__line"><span class="c-code__preprocessor">#define OPTION_MESSAGE(m, o, s) printf(&quot;  %s, %s%*s: %s\n&quot;, o, s, OPTION_PADDING(o), &quot; &quot;, m);</span></div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keywordtype">void</span> printHelp() {</div><div class="c-code__line">    printf(<span class="c-code__stringliteral">&quot;Available options are:\n&quot;</span>);</div><div class="c-code__line">    OPTION_MESSAGE(<span class="c-code__stringliteral">&quot;Path to a 51Degrees Hash data file&quot;</span>, DATA_OPTION, DATA_OPTION_SHORT);</div><div class="c-code__line">    OPTION_MESSAGE(<span class="c-code__stringliteral">&quot;Path to a User-Agents YAML file&quot;</span>, UA_OPTION, UA_OPTION_SHORT);</div><div class="c-code__line">    OPTION_MESSAGE(<span class="c-code__stringliteral">&quot;Number of threads to run&quot;</span>, THREAD_OPTION, THREAD_OPTION_SHORT);</div><div class="c-code__line">    OPTION_MESSAGE(<span class="c-code__stringliteral">&quot;Number of iterations per thread&quot;</span>, ITERATIONS_OPTION, ITERATIONS_OPTION_SHORT);</div><div class="c-code__line">    OPTION_MESSAGE(<span class="c-code__stringliteral">&quot;Path to a file to output JSON format results to&quot;</span>, JSON_OPTION, JSON_OPTION_SHORT);</div><div class="c-code__line">    OPTION_MESSAGE(<span class="c-code__stringliteral">&quot;Print this help&quot;</span>, HELP_OPTION, HELP_OPTION_SHORT);</div><div class="c-code__line">}</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__keywordtype">int</span> main(<span class="c-code__keywordtype">int</span> argc, <span class="c-code__keywordtype">char</span>* argv[]) {</div><div class="c-code__line"></div><div class="c-code__line">    <a class="code" href="group___fifty_one_degrees_status.html#ga887881c8b6ec9f0c8510913831ebd19e">StatusCode</a> status = <a class="code" href="group___fifty_one_degrees_synonyms.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>;</div><div class="c-code__line">    <span class="c-code__keywordtype">char</span> dataFilePath[<a name="a108"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#gafd3ee670ff4ed3f29a395abd2f0f3344">FILE_MAX_PATH</a>];</div><div class="c-code__line">    <span class="c-code__keywordtype">char</span> evidenceFilePath[<a class="code" href="group___fifty_one_degrees_synonyms.html#gafd3ee670ff4ed3f29a395abd2f0f3344">FILE_MAX_PATH</a>];</div><div class="c-code__line">    uint16_t numberOfThreads = DEFAULT_NUMBER_OF_THREADS;</div><div class="c-code__line">    <span class="c-code__keywordtype">int</span> iterationsPerThread = DEFAULT_ITERATIONS_PER_THREAD;</div><div class="c-code__line">    <span class="c-code__keywordtype">char</span> *outFile = NULL;</div><div class="c-code__line">    dataFilePath[0] = <span class="c-code__charliteral">&#39;\0&#39;</span>;</div><div class="c-code__line">    evidenceFilePath[0] = <span class="c-code__charliteral">&#39;\0&#39;</span>;</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keywordflow">for</span> (<span class="c-code__keywordtype">int</span> i = 0; i &lt; argc; i++) {</div><div class="c-code__line">        <span class="c-code__keywordflow">if</span> (strcmp(argv[i], DATA_OPTION) == 0 ||</div><div class="c-code__line">            strcmp(argv[i], DATA_OPTION_SHORT) == 0) {</div><div class="c-code__line">            <span class="c-code__comment">// Set data file path</span></div><div class="c-code__line">            strcpy(dataFilePath, argv[i + 1]);</div><div class="c-code__line">        }</div><div class="c-code__line">        <span class="c-code__keywordflow">else</span> <span class="c-code__keywordflow">if</span> (strcmp(argv[i], UA_OPTION) == 0 ||</div><div class="c-code__line">            strcmp(argv[i], UA_OPTION_SHORT) == 0) {</div><div class="c-code__line">            <span class="c-code__comment">// Set evidence file path</span></div><div class="c-code__line">            strcpy(evidenceFilePath, argv[i + 1]);</div><div class="c-code__line">        }</div><div class="c-code__line">        <span class="c-code__keywordflow">else</span> <span class="c-code__keywordflow">if</span> (strcmp(argv[i], THREAD_OPTION) == 0 ||</div><div class="c-code__line">            strcmp(argv[i], THREAD_OPTION_SHORT) == 0) {</div><div class="c-code__line">            <span class="c-code__comment">// Set the number of threads</span></div><div class="c-code__line">            numberOfThreads = (uint16_t)atoi(argv[i + 1]);</div><div class="c-code__line">        }</div><div class="c-code__line">        <span class="c-code__keywordflow">else</span> <span class="c-code__keywordflow">if</span> (strcmp(argv[i], JSON_OPTION) == 0 ||</div><div class="c-code__line">            strcmp(argv[i], JSON_OPTION_SHORT) == 0) {</div><div class="c-code__line">            <span class="c-code__comment">// Set the JSON results file</span></div><div class="c-code__line">            outFile = argv[i + 1];</div><div class="c-code__line">        }</div><div class="c-code__line">        <span class="c-code__keywordflow">else</span> <span class="c-code__keywordflow">if</span> (strcmp(argv[i], ITERATIONS_OPTION) == 0 ||</div><div class="c-code__line">            strcmp(argv[i], ITERATIONS_OPTION_SHORT) == 0) {</div><div class="c-code__line">            <span class="c-code__comment">// Set the iterations per thread</span></div><div class="c-code__line">            iterationsPerThread = atoi(argv[i + 1]);</div><div class="c-code__line">        }</div><div class="c-code__line">        <span class="c-code__keywordflow">else</span> <span class="c-code__keywordflow">if</span> (strcmp(argv[i], HELP_OPTION) == 0 ||</div><div class="c-code__line">            strcmp(argv[i], HELP_OPTION_SHORT) == 0) {</div><div class="c-code__line">            <span class="c-code__comment">// Print the help options</span></div><div class="c-code__line">            printHelp();</div><div class="c-code__line">            <span class="c-code__keywordflow">return</span> 0;</div><div class="c-code__line">        }</div><div class="c-code__line">        <span class="c-code__keywordflow">else</span> <span class="c-code__keywordflow">if</span> (argv[i][0] == <span class="c-code__charliteral">&#39;-&#39;</span>) {</div><div class="c-code__line">            <span class="c-code__comment">// Something invalid was entered, so do not continue</span></div><div class="c-code__line">            printf(</div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;The option &#39;%s&#39; is not recognized. Use %s (%s) to list options.&quot;</span>,</div><div class="c-code__line">                argv[i],</div><div class="c-code__line">                HELP_OPTION,</div><div class="c-code__line">                HELP_OPTION_SHORT);</div><div class="c-code__line">            <span class="c-code__keywordflow">return</span> 1;</div><div class="c-code__line">        }</div><div class="c-code__line">        <span class="c-code__keywordflow">else</span> {</div><div class="c-code__line">            <span class="c-code__comment">// Do nothing, this is a value.</span></div><div class="c-code__line">        }</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (strlen(dataFilePath) == 0) {</div><div class="c-code__line">        status = <a name="a109"></a><a class="code" href="group___fifty_one_degrees_synonyms.html#ga5ba06bcfd18437e9145833037dd7ecc9">FileGetPath</a>(</div><div class="c-code__line">            dataDir,</div><div class="c-code__line">            dataFileName,</div><div class="c-code__line">            dataFilePath,</div><div class="c-code__line">            <span class="c-code__keyword">sizeof</span>(dataFilePath));</div><div class="c-code__line">        <span class="c-code__keywordflow">if</span> (status != <a class="code" href="group___fifty_one_degrees_synonyms.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>) {</div><div class="c-code__line">            printf((<span class="c-code__stringliteral">&quot;Failed to find a device detection &quot;</span></div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;data file. Make sure the device-detection-data &quot;</span></div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;submodule has been updated by running &quot;</span></div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;`git submodule update --recursive`\n&quot;</span>));</div><div class="c-code__line">            fgetc(stdin);</div><div class="c-code__line">            <span class="c-code__keywordflow">return</span> 1;</div><div class="c-code__line">        }</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (strlen(evidenceFilePath) == 0) {</div><div class="c-code__line">        status = <a class="code" href="group___fifty_one_degrees_synonyms.html#ga5ba06bcfd18437e9145833037dd7ecc9">FileGetPath</a>(</div><div class="c-code__line">            dataDir,</div><div class="c-code__line">            evidenceFileName,</div><div class="c-code__line">            evidenceFilePath,</div><div class="c-code__line">            <span class="c-code__keyword">sizeof</span>(evidenceFilePath));</div><div class="c-code__line">        <span class="c-code__keywordflow">if</span> (status != <a class="code" href="group___fifty_one_degrees_synonyms.html#gaa90cac659d18e8ef6294c7ae337f6b58">SUCCESS</a>) {</div><div class="c-code__line">            printf((<span class="c-code__stringliteral">&quot;Failed to find a device detection &quot;</span></div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;evidence file. Make sure the device-detection-data &quot;</span></div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;submodule has been updated by running &quot;</span></div><div class="c-code__line">                <span class="c-code__stringliteral">&quot;`git submodule update --recursive`\n&quot;</span>));</div><div class="c-code__line">            fgetc(stdin);</div><div class="c-code__line">            <span class="c-code__keywordflow">return</span> 1;</div><div class="c-code__line">        }</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    ExampleParameters params;</div><div class="c-code__line">    params.dataFilePath = dataFilePath;</div><div class="c-code__line">    params.evidenceFilePath = evidenceFilePath;</div><div class="c-code__line">    params.numberOfThreads = numberOfThreads;</div><div class="c-code__line">    params.iterationsPerThread = iterationsPerThread;</div><div class="c-code__line">    params.output = stdout;</div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (outFile != NULL) {</div><div class="c-code__line">        params.resultsOutput = fopen(outFile, <span class="c-code__stringliteral">&quot;w&quot;</span>);</div><div class="c-code__line">    }</div><div class="c-code__line">    <span class="c-code__keywordflow">else</span> {</div><div class="c-code__line">        params.resultsOutput = NULL;</div><div class="c-code__line">    }</div><div class="c-code__line">    <span class="c-code__comment">// Run the example</span></div><div class="c-code__line">    fiftyoneDegreesExampleMemCheck(</div><div class="c-code__line">        &amp;params,</div><div class="c-code__line">        fiftyoneDegreesExampleCPerformanceRun);</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keywordflow">if</span> (outFile != NULL) {</div><div class="c-code__line">        fclose(params.resultsOutput);</div><div class="c-code__line">    }</div><div class="c-code__line"></div><div class="c-code__line">    <span class="c-code__keywordflow">return</span> 0;</div><div class="c-code__line">}</div><div class="c-code__line"></div><div class="c-code__line"><span class="c-code__preprocessor">#endif</span></div></div> </div><!-- primary -->
</div><!-- inner-->
<!-- HTML footer for doxygen 1.8.15-->
<!-- start footer part -->
<section id="nav-path" class="g-footer g-footer--docs"><!-- id is needed for treeview function! -->
    <p class="g-footer__copyright">Generated by
    <a href="http://www.doxygen.org/index.html">
    <b>doxygen</b></a> 1.8.15
  </p>
</section>
</div>
</main>
</div>
</body>
</html>
